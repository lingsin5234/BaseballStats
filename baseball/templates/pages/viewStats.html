{% include 'partials/header_baseball.html' %}
    <!-- Data Tables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.js"></script>

    <div id="my_title" class="d-flex justify-content-center">
        <h1>View Team Stats</h1>
    </div><br>

    {% load crispy_forms_tags %}
    <form id="view_stats" method="post" data-teams-url="{% url 'ajax_load_teams' %}" novalidate>
        {% csrf_token %}
        {{ form_view_stats.as_table }}
        <!--input type="submit" value="View Stats"-->
    </form>

    <div id="selected" class="d-flex justify-content-center">
        <h3>{{ heading }}</h3>
    </div><br>
    <div id="table_output" class="d-flex justify-content-center"></div>

    {% load static %}
    <script src="{% static 'scripts/baseball/view_stats.js' %}"></script>
    <br>

    <script>
    // for the teams drop-down dependency
    $("#id_year").change(function () {
        var url = $("#view_stats").attr("data-teams-url");  // get the url of the `load_teams` view
        var yearId = $(this).val();  // get selected YEAR
        //console.log(url);
        // initialize an AJAX request
        $.ajax({
            //async: true,
            url: url,  // set the url of the request (= localhost:8000/ajax/load-teams/)
            data: {
                'year': yearId  // add the year id to the GET parameters
            },
            success: function (data) {  // `data` is the return of the `load_teams` view function
                //console.log(data);
                $("#id_team").html(data);  // replace with the values retrieved
            }
        });
    });

    // instantiate StatsTable
    $(document).ready(function() {
        callAPI();
        window.results = {{results|safe}};
        window.heading = '{{heading}}';
        window.columns = {{post_col|safe}};
        window.bat_col = {{bat_col|safe}};
        StatsTable = new StatsTable("#table_stats");
        // call DataTable js
        $('#table_stats').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": callAPI()
        });
    });

    // call API on Team selector change
    $("#id_team").change(function() {
        // call API
        callAPI();
    });

    // call API function
    function callAPI() {
        var yearId = $('#id_year').val();  // get selected YEAR
        var teamId = $('#id_team').val();  // get selected TEAM
        var output;
        $.ajax({
            url: "/stat_results",
            type: "POST",
            data: {
                'year': yearId,
                'team': teamId
            },
            success: function(data) {
                results = data[0]['results'];
                heading = data[0]['heading'];
                columns = data[0]['post_col'];
                console.log(results);
                StatsTable.wrangleData();
            },
            error: function(error) {
                console.log("API ERROR");
                console.log(error);
            }
        });
    };
    </script>

{% include 'partials/footer_baseball.html' %}
